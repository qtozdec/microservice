apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-config
  namespace: devops
  labels:
    app: postgres
data:
  POSTGRES_DB: "devops"
  POSTGRES_USER: "postgres"
  PGDATA: "/var/lib/postgresql/data/pgdata"
  # Performance tuning for 32GB RAM system
  POSTGRES_SHARED_BUFFERS: "2GB"
  POSTGRES_EFFECTIVE_CACHE_SIZE: "6GB"
  POSTGRES_MAINTENANCE_WORK_MEM: "512MB"
  POSTGRES_CHECKPOINT_COMPLETION_TARGET: "0.9"
  POSTGRES_WAL_BUFFERS: "16MB"
  POSTGRES_DEFAULT_STATISTICS_TARGET: "100"
  POSTGRES_RANDOM_PAGE_COST: "1.1"
  POSTGRES_EFFECTIVE_IO_CONCURRENCY: "200"
  POSTGRES_WORK_MEM: "32MB"
  POSTGRES_MIN_WAL_SIZE: "1GB"
  POSTGRES_MAX_WAL_SIZE: "4GB"
  POSTGRES_MAX_WORKER_PROCESSES: "12"
  POSTGRES_MAX_PARALLEL_WORKERS_PER_GATHER: "4"
  POSTGRES_MAX_PARALLEL_WORKERS: "12"
  POSTGRES_MAX_PARALLEL_MAINTENANCE_WORKERS: "4"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-initdb
  namespace: devops
  labels:
    app: postgres
data:
  init.sql: |
    -- Create databases for microservices
    CREATE DATABASE user_service_db;
    CREATE DATABASE order_service_db;
    CREATE DATABASE notification_service_db;
    CREATE DATABASE inventory_service_db;
    CREATE DATABASE audit_service_db;
    CREATE DATABASE gitlab;
    
    -- Create users for each service
    CREATE USER microservices_user WITH ENCRYPTED PASSWORD 'changeme';
    CREATE USER gitlab_user WITH ENCRYPTED PASSWORD 'gitlab_pass';
    
    -- Grant privileges on databases
    GRANT ALL PRIVILEGES ON DATABASE user_service_db TO microservices_user;
    GRANT ALL PRIVILEGES ON DATABASE order_service_db TO microservices_user;
    GRANT ALL PRIVILEGES ON DATABASE notification_service_db TO microservices_user;
    GRANT ALL PRIVILEGES ON DATABASE inventory_service_db TO microservices_user;
    GRANT ALL PRIVILEGES ON DATABASE audit_service_db TO microservices_user;
    GRANT ALL PRIVILEGES ON DATABASE gitlab TO gitlab_user;
    
    -- Connect to each database and grant schema privileges
    \c user_service_db;
    GRANT ALL PRIVILEGES ON SCHEMA public TO microservices_user;
    GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO microservices_user;
    GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO microservices_user;
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL PRIVILEGES ON TABLES TO microservices_user;
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL PRIVILEGES ON SEQUENCES TO microservices_user;
    
    \c order_service_db;
    GRANT ALL PRIVILEGES ON SCHEMA public TO microservices_user;
    GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO microservices_user;
    GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO microservices_user;
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL PRIVILEGES ON TABLES TO microservices_user;
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL PRIVILEGES ON SEQUENCES TO microservices_user;
    
    \c notification_service_db;
    GRANT ALL PRIVILEGES ON SCHEMA public TO microservices_user;
    GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO microservices_user;
    GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO microservices_user;
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL PRIVILEGES ON TABLES TO microservices_user;
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL PRIVILEGES ON SEQUENCES TO microservices_user;
    
    \c inventory_service_db;
    GRANT ALL PRIVILEGES ON SCHEMA public TO microservices_user;
    GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO microservices_user;
    GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO microservices_user;
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL PRIVILEGES ON TABLES TO microservices_user;
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL PRIVILEGES ON SEQUENCES TO microservices_user;
    
    \c audit_service_db;
    GRANT ALL PRIVILEGES ON SCHEMA public TO microservices_user;
    GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO microservices_user;
    GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO microservices_user;
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL PRIVILEGES ON TABLES TO microservices_user;
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL PRIVILEGES ON SEQUENCES TO microservices_user;
    
    \c gitlab;
    GRANT ALL PRIVILEGES ON SCHEMA public TO gitlab_user;
    GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO gitlab_user;
    GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO gitlab_user;
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL PRIVILEGES ON TABLES TO gitlab_user;
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL PRIVILEGES ON SEQUENCES TO gitlab_user;